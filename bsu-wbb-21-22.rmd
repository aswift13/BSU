---
title: "Ball State University 2021 - 2022 Womens Basketball Season"
author: "Alan Morales"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    theme: united

---


```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
```


## Introduction 


I'll be using this R-markdown to utilize data visualizations tools on season statistics for Ball State Women's basketball 2021-2022 season. Field Goal Attempts, Effective Field Goal Percentage[(FGM + 0.5 x TPFGM)/FGA = EFG%], Free Throw Attempts and Free Throw Field Goal Percentage. 


```{r message=FALSE, warning=FALSE, include=FALSE}

library(tidyverse) #Working with data
library(readxl) #To get data out of excel files
library(scales)
library(dplyr)
library(aod)
library(reshape2)
library(plotly)
library(gtsummary)
library(psych)
library(gganimate)
library(ggplot2)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
#Gets the sheet names of each sheet in the xlsx file. No statistics are attained. 

Sht_names = excel_sheets('../input/bsu-20212022-wbb-season/BSU_WBB.xlsx')

```



```{r message=FALSE, warning=FALSE, include=FALSE}
#Creating a data frame containing all statistics by sheets. 

df = lapply(setNames(Sht_names,Sht_names), function(s) read_excel('../input/bsu-20212022-wbb-season/BSU_WBB.xlsx',sheet = s))
```
  
```{r echo=FALSE, message=FALSE, warning=FALSE}
#Binds all the sheets together to one data set with all observations.

df = bind_rows(df, .id="Sheet")
```


```{r echo=FALSE}
#Create new variables

df$FG_Per   <- df$FG_M / df$FG_A
df$'3P_Per' <- df$`3P_M` / df$`3P_A`
df$FT_Per   <- df$FT_M / df$FT_A
df$Points   <- (df$FG_M - df$`3P_M`)*2 + df$`3P_M` * 3 + df$FT_M
df$ARP  <- ((df$FG_M - df$`3P_M`)*2 + df$`3P_M` * 3 + df$FT_M) + df$Assist+ df$Rebounds_Total
df$EFG      <- (df$FG_M + (0.5 * df$`3P_M` ))/df$FG_A

```


```{r include=FALSE}
#Adding player names to data frame by player number. 

df <- df %>%
  mutate(Player_Name = case_when(
    Player_Number == 0 ~ "Ally Becki",
    Player_Number == 1 ~ "Skyla Knight",
    Player_Number == 2 ~ "Chyna Latimer",
    Player_Number == 3 ~ "Cameron Grant",
    Player_Number == 5 ~ "Makenna Burch",
    Player_Number == 10 ~ "Thelma Dis Agustsdottir",
    Player_Number == 11 ~ "Sydney Freeman",
    Player_Number == 13 ~ "Ivet Subirats",
    Player_Number == 14 ~ "Marie Kiefer",
    Player_Number == 20 ~ "Jazmyn Turner",
    Player_Number == 21 ~ "Blake Smith",
    Player_Number == 22 ~ "Estel Puiggros",
    Player_Number == 24 ~ "Maddie Bischoff",
    Player_Number == 30 ~ "Anna Clephane",
    Player_Number == 42 ~ "Annie Raunch",
  )
  )
```

```{r include=FALSE}
# Adding a new TeamCase to get a binary table. 

df <- df %>%
  mutate(TeamCase = ifelse( Team == "BSU", "BSU", "OPP" )
  )
```

```{r}
#Making a data set of player and team only statistics

dfplayers <- df[complete.cases(df$Player_Number), ] 
dfteam <- df[complete.cases(df$Team), ] 

```




```{r}

tp = dfplayers %>%
      group_by(Player_Name) %>%
  
      select(Points, Assist, Rebounds_Total, Steals, Time_Total) %>%
  summarise(
    Points_Per_Game = mean(Points, na.rm = TRUE),
    Assists_Per_Game = mean(Assist, na.rm = TRUE),
    Total_Assists = sum(Assist, na.rm = TRUE),
    Rebounds_Per_Game = mean(Rebounds_Total, na.rm = TRUE),
    Total_Rebounds = sum(Rebounds_Total, na.rm = TRUE),
    Steals_Per_Game = mean(Steals, na.rm = TRUE),
    Total_Points = sum(Points, na.rm = TRUE),
    Min_Per_Game = mean(Time_Total, na.rm = TRUE)/60,
    Total_ARP = Total_Points + Total_Rebounds + Total_Assists
    )
  
is.num <- sapply(tp, is.numeric)
tp[is.num] <- lapply(tp[is.num], round,2)
```


## Statistical Summary of players and team.  

Season statistics by player given by mean (standard deviation)
```{r}
data1 <- dfplayers %>% select(Points, FG_Per, '3P_Per', FT_Per, Assist, Player_Name, Rebounds_Total) 


table1 <- 
  tbl_summary(
    data1, 
    statistic = list(all_continuous() ~'{mean} ({sd})'),
    by = Player_Name,
    missing = "no"
  )
table1
```

```{r}
data2 <- dfteam %>% select(Points, FG_Per, '3P_Per', FT_Per, Assist, TeamCase, Rebounds_Total) 


table2 <- 
  tbl_summary(
    data2, 
    statistic = list(all_continuous() ~'{mean} ({sd})'),
       digits = all_continuous() ~ 1,
    by = TeamCase,
    missing = "no"
  )
table2
```



```{r include=FALSE}
#sapply(df,  sd, na.rm = TRUE )
```




## Data visualization

### Field Goal Attempts

```{r}
fig1 <- plot_ly(dfplayers, x = ~ W_L, y = ~FG_A, color = ~Player_Name ,  type = "box" )
fig1 <-  fig1 %>% layout(boxmode = "group", xaxis= list(title = "Win or Loss"), yaxis = list(title = "FG Attempts"))
fig1

fig2 <- plot_ly(dfplayers, x = ~ H_A, y = ~FG_A, color = ~Player_Name ,  type = "box" )
fig2 <-  fig2 %>% layout(boxmode = "group",xaxis= list(title = "Home or Away"), yaxis = list(title = "FG Attempts"))
fig2


```



### Effective Field Goal Percentage


```{r}
fig3 <- plot_ly(dfplayers, x = ~ W_L, y = ~EFG, color = ~Player_Name ,  type = "box" )
fig3 <-  fig3 %>% layout(boxmode = "group", xaxis= list(title = "Win or Loss"), yaxis = list(title = "EFG %"))
fig3

fig4 <- plot_ly(dfplayers, x = ~ H_A, y = ~EFG, color = ~Player_Name ,  type = "box" )
fig4 <-  fig4 %>% layout(boxmode = "group",xaxis= list(title = "Home or Away"), yaxis = list(title = "EFG %"))
fig4


```

### Free Throw Attempts

```{r}
fig5 <- plot_ly(dfplayers, x = ~ W_L, y = ~FT_A, color = ~Player_Name ,  type = "box" )
fig5 <-  fig5 %>% layout(boxmode = "group", xaxis= list(title = "Win or Loss"), yaxis = list(title = "FT Attempts"))
fig5

fig6 <- plot_ly(dfplayers, x = ~ H_A, y = ~FT_A, color = ~Player_Name ,  type = "box" )
fig6 <-  fig6 %>% layout(boxmode = "group",xaxis= list(title = "Home or Away"), yaxis = list(title = "FT Attempts"))
fig6


```

### Free Throw Field Goal Percentage


```{r}
fig7 <- plot_ly(dfplayers, x = ~ W_L, y = ~FT_Per, color = ~Player_Name ,  type = "box" )
fig7 <-  fig7 %>% layout(boxmode = "group", xaxis= list(title = "Win or Loss"), yaxis = list(title = "FT %"))
fig7

fig8 <- plot_ly(dfplayers, x = ~ H_A, y = ~FT_Per, color = ~Player_Name ,  type = "box" )
fig8 <-  fig8 %>% layout(boxmode = "group",xaxis= list(title = "Home or Away"), yaxis = list(title = "FT Per"))
fig8


```
### FGA, EFG, FG_A, and FG_% Summary 


```{r}
datax <- 
  dfteam %>% 
  select(FG_A, EFG, FT_A, FT_Per, TeamCase, H_A) %>%
  mutate(H_A = paste("Home or Away =", H_A)) %>%
  tbl_strata( 
     strata = H_A,
     .tbl_fun = 
       ~ .x %>% 
       tbl_summary(by = TeamCase, 
    statistic = list(all_continuous() ~'{mean} ({sd})'),
       digits = all_continuous() ~ 2,) %>%
       add_n(),
     .header = "**{strata}** ,N = {n}")


datay <- 
  dfteam %>% 
  select(FG_A, EFG, FT_A, FT_Per, TeamCase, W_L) %>%
  mutate(W_L = paste("Win or Loss =", W_L)) %>%
  tbl_strata( 
     strata = W_L,
     .tbl_fun = 
       ~ .x %>% 
       tbl_summary(by = TeamCase, 
    statistic = list(all_continuous() ~'{mean} ({sd})'),
       digits = all_continuous() ~ 2,) %>%
       add_n(),
     .header = "**{strata}** ,N = {n}")
datax
datay
```
## Cumulative statistics


Cumulative box plots based on solely total points and totals for assist, rebounds, and points. 


```{r}
bp <- ggplot(tp, aes(x="", y = Total_Points, fill=Player_Name))+
  geom_bar(width=1, stat = "Identity") + xlab("BSU total points") +ylab("Points by each player")

bpa <-   ggplot(tp, aes(x="", y = Total_ARP, fill=Player_Name))+
  geom_bar(width=1, stat = "Identity") + xlab("BSU total points, assists and rebounds") +ylab("Points, assist and rebounds by each player")


par(mfrow = c(1,2))
bp

bpa
```


Number of occurrences of each Point/Assist/Rebound total. 

```{r}

ggplot(dfplayers) + geom_histogram(aes(x = ARP, fill =Player_Name)) 


#ggplot(dfplayers, aes(x = Tot_arp)) + geom_histogram(aes(y = ..density.., fill =Player_Name),   binwidth = .5, colour = "blue") + geom_density( fill="#FF6655")

#meanarp <- mean(dfplayers$ARP)
#sdarp <- sd(dfplayers$ARP)

#xarp <- seq(-40,40,by = 1)
#distarp <- dnorm(xarp,mean =  meanarp, sd =  sdarp)
#arpplot <-plot(xarp, distarp)
```

Points/assists/rebounds each player has per game in chronological order.  

```{r}
p <- ggplot(dfplayers, aes(x = Game_Number, y = ARP )) +
  geom_line(aes(color = Player_Name, linetype = Player_Name))+ xlab("Game Number") + ylab("Total Points/Rebounds/Assists")
fig <- ggplotly(p)
fig
```
## Field Goal Percentages

```{r echo=FALSE}

theme_set(theme_classic())


#Plot
ggplot(dfplayers, aes(x=Player_Name, y= FG_Per)) + 
 
  geom_point(aes(group = H_A, color = H_A, size = 1 ))+
  
  geom_segment(aes(x=Player_Name,
                   xend=Player_Name,
                   y=min(FG_Per),
                   yend=max(FG_Per)),
               size = 1)+
               
               labs(title = "Location based FG %",
                   subtitle = "FG % by Player",
                    caption = "source: BSU Athletics pdf box scores.")+ coord_flip() + ylab("Field Goal Percentage") + xlab("Player")

```

```{r echo=FALSE, warning=FALSE}

theme_set(theme_classic())


#Plot
ggplot(dfplayers, aes(x=Player_Name, y= FG_Per)) + 
 
  geom_point(aes(group = W_L, color = W_L, size = 1 ))+
  
  geom_segment(aes(x=Player_Name,
                   xend=Player_Name,
                   y=min(FG_Per),
                   yend=max(FG_Per)),
               size = 1)+
               
               labs(title = "Win/Loss based FG %",
                    subtitle = "FG % by Player",
                    caption = "source: BSU Athletics pdf box scores.")+ coord_flip()+ ylab("Field Goal Percentage") + xlab("Player")


```


```{r }
theme_set(theme_bw())
g <- ggplot(dfplayers, aes(H_A, FG_Per))
g + geom_count(col = "tomato3", show.legend = F)+
  labs(subtitle = "Field Goal percentage based on location",
       y = "Field Percentage",
       x = "Home or Away")

theme_set(theme_bw())
g <- ggplot(dfplayers, aes(W_L, FG_Per))
g + geom_count(col = "tomato3", show.legend = F)+
  labs(subtitle = "Field Goal percentage based on Result",
       y = "Field Percentage",
       x = "Result")
```











```{r include=FALSE}
df <- df %>%
  mutate(W_L_B = case_when(
    W_L == "W" ~ 1,
    W_L == "L" ~ 0
  ))
dfplayers <- dfplayers %>%
  mutate(W_L_B = case_when(
    W_L == "W" ~ 1,
    W_L == "L" ~ 0
  ))


```








## Generating a generalized linear model 
```{r}
dfteam <- df[complete.cases(df$Team), ] 
mylogit <- glm(W_L_B ~ EFG + FG_A + Rebounds_Total + FT_A + Assist + FG_Per   , data = dfteam, family = binomial(link = probit) )

summary(mylogit)
```
```{r}
mylogit
```

