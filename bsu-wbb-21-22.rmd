# %% [code]
---
title: "Ball State University 2021 - 2022 Womens Basketball Season"
author: "Alan Morales"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    theme: united

---


```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
```


## Introduction 


I'll be using this R-markdown to utilize data visualizations tools on season statistics for Ball State Women's basketball 2021-2022 season. Field Goal Attempts, Effective Field Goal Percentage[(FGM + 0.5 x TPFGM)/FGA = EFG%], Free Throw Attempts and Free Throw Field Goal Percentage. 


```{r message=FALSE, warning=FALSE, include=FALSE}

library(tidyverse) #Working with data
library(readxl) #To get data out of excel files
library(scales)
library(dplyr)
library(aod)
library(reshape2)
library(plotly)
library(gtsummary)
library(psych)
library(gganimate)
library(ggplot2)
library(kableExtra)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
#Gets the sheet names of each sheet in the xlsx file. No statistics are attained. 

Sht_names = excel_sheets('../input/bsu-20212022-wbb-season/BSU_WBB.xlsx')

```



```{r message=FALSE, warning=FALSE, include=FALSE}
#Creating a data frame containing all statistics by sheets. 

df = lapply(setNames(Sht_names,Sht_names), function(s) read_excel('../input/bsu-20212022-wbb-season/BSU_WBB.xlsx',sheet = s))
```
  
```{r echo=FALSE, message=FALSE, warning=FALSE}
#Binds all the sheets together to one data set with all observations.

df = bind_rows(df, .id="Sheet")
```

Here I add the new variables and player names to the data frame.
```{r echo=TRUE, message=FALSE, warning=FALSE}
#Create new variables

df$FG_Per   <- df$FG_M / df$FG_A
df$'3P_Per' <- df$`3P_M` / df$`3P_A`
df$FT_Per   <- df$FT_M / df$FT_A
df$Points   <- (df$FG_M - df$`3P_M`)*2 + df$`3P_M` * 3 + df$FT_M
df$ARP  <- ((df$FG_M - df$`3P_M`)*2 + df$`3P_M` * 3 + df$FT_M) + df$Assist+ df$Rebounds_Total
df$EFG      <- (df$FG_M + (0.5 * df$`3P_M` ))/df$FG_A

#Adding player names to data frame by player number. 

df <- df %>%
  mutate(Player_Name = case_when(
    Player_Number == 0 ~ "Ally Becki",
    Player_Number == 1 ~ "Skyla Knight",
    Player_Number == 2 ~ "Chyna Latimer",
    Player_Number == 3 ~ "Cameron Grant",
    Player_Number == 5 ~ "Makenna Burch",
    Player_Number == 10 ~ "Thelma Dis Agustsdottir",
    Player_Number == 11 ~ "Sydney Freeman",
    Player_Number == 13 ~ "Ivet Subirats",
    Player_Number == 14 ~ "Marie Kiefer",
    Player_Number == 20 ~ "Jazmyn Turner",
    Player_Number == 21 ~ "Blake Smith",
    Player_Number == 22 ~ "Estel Puiggros",
    Player_Number == 24 ~ "Maddie Bischoff",
    Player_Number == 30 ~ "Anna Clephane",
    Player_Number == 42 ~ "Annie Raunch",
  )
  )
```

A  team and player data frame are created. 
```{r echo=TRUE, message=FALSE, warning=FALSE}
# Adding a new TeamCase to get a binary table. 

df <- df %>%
  mutate(TeamCase = ifelse( Team == "BSU", "BSU", "OPP" )
  )
#Making a data set of player and team only statistics

dfplayers <- df[complete.cases(df$Player_Number), ] 
dfteam <- df[complete.cases(df$Team), ] 
```

A third data frame to work with accumulated statistics. 
```{r}
# dfplayers is used to attain data for new data frame tp. 
tp = dfplayers %>%
      group_by(Player_Name) %>%
  
  #The sum totals and means are attained. 
      select(Points, Assist, Rebounds_Total, Steals, Time_Total) %>%
  summarise(
    Points_Per_Game = mean(Points, na.rm = TRUE),
    Assists_Per_Game = mean(Assist, na.rm = TRUE),
    Total_Assists = sum(Assist, na.rm = TRUE),
    Rebounds_Per_Game = mean(Rebounds_Total, na.rm = TRUE),
    Total_Rebounds = sum(Rebounds_Total, na.rm = TRUE),
    Steals_Per_Game = mean(Steals, na.rm = TRUE),
    Total_Points = sum(Points, na.rm = TRUE),
    Min_Per_Game = mean(Time_Total, na.rm = TRUE)/60,
    Total_ARP = Total_Points + Total_Rebounds + Total_Assists
    )
  
# I think this rounds the numbers to two decimals places if the column is numeric. 
is.num <- sapply(tp, is.numeric)
tp[is.num] <- lapply(tp[is.num], round,2)
```

# Data

## Statistical Summary of players and team.  

### Player statistics. MEAN (SD)
```{r}
#creating a table with different statistics that every basketball aficionado should know. 
table1 <- 
  tbl_summary(
    dfplayers[, c('Points', 'FG_Per', '3P_Per', 'FT_Per', 'Assist', 'Player_Name', 'Rebounds_Total')], 
    statistic = list(all_continuous() ~'{mean} ({sd})'),
    by = Player_Name,
    missing = "no"
  )
table1
```


### Team statistics. MEAN (SD)
```{r echo=FALSE}
# Table of meaningful team based statistics 
table2 <- 
  tbl_summary(
    dfteam[,c('Points', 'FG_Per', '3P_Per', 'FT_Per', 'Assist', 'TeamCase', 'Rebounds_Total') ], 
    statistic = list(all_continuous() ~'{mean} ({sd})'),
       digits = all_continuous() ~ 2,
    by = TeamCase,
    missing = "no"
  )
table2
```

### Statitics of FG_A, EFG%, FT_A and FT%. 

```{r}
#Stratified table based on location
data001 <- 
  dfteam %>% 
  select(FG_A, EFG, FT_A, FT_Per, TeamCase, H_A) %>%
  mutate(H_A = paste("Home or Away =", H_A)) %>%
  tbl_strata( 
     strata = H_A,
     .tbl_fun = 
       ~ .x %>% 
       tbl_summary(by = TeamCase, 
    statistic = list(all_continuous() ~'{mean} ({sd})'),
       digits = all_continuous() ~ 2,) %>%
       add_n(),
     .header = "**{strata}** ,N = {n}")
```


```{r echo=FALSE}
#stratified table based on results. 
data002 <- 
  dfteam %>% 
  select(FG_A, EFG, FT_A, FT_Per, TeamCase, W_L) %>%
  mutate(W_L = paste("Win or Loss =", W_L)) %>%
  tbl_strata( 
     strata = W_L,
     .tbl_fun = 
       ~ .x %>% 
       tbl_summary(by = TeamCase, 
    statistic = list(all_continuous() ~'{mean} ({sd})'),
       digits = all_continuous() ~ 2,) %>%
       add_n(),
     .header = "**{strata}** ,N = {n}")
data001
data002
```


# Figures 
## Cumulative statistics


Cumulative box plots based on solely total points and totals for assist, rebounds, and points. 


```{r message=FALSE, warning=FALSE}
# I order the data frame by total points so that the columns are appropriately stacked. 
attach(tp)
tp <- tp[order(-Total_Points),]

tp$Player_Name <- factor(tp$Player_Name, levels = tp$Player_Name[order(tp$Total_Points)], ordered = TRUE)

#Take away occurrences below 74 total points becuase they wouldn't fit on the graph. 
tp$PNP <- as.numeric(tp$Total_Points)
tp$PNP[which(tp$Total_Points <74)] <- NA


# this is the ggplot stacked bar graph
bp <- 
  ggplot(tp, aes(x="", y = Total_Points))+
  
  geom_bar(aes(fill = Player_Name),width=1, stat = "Identity") + 
  geom_text(aes(label = PNP),position = position_stack(vjust = 0.5),
    size=3.3)+
  
  xlab("BSU total points") +
  ylab("Points by each player") 

```


```{r message=FALSE, warning=FALSE, include=FALSE}
#data is rodered by total ARP
attach(tp)
tp <- tp[order(-Total_ARP),]

tp$Player_Name <- factor(tp$Player_Name, levels = tp$Player_Name[order(tp$Total_ARP)], ordered = TRUE)

# players with less than 100 ARP will not have the total labeled on their part.
tp$TARP <- as.numeric(tp$Total_ARP)
tp$TARP[which(tp$Total_ARP <100)] <- NA 

# plot of the stacked bar graph
barp <- 
  ggplot(tp, aes(x="", y = Total_ARP))+
  
  geom_bar(aes(fill = Player_Name),width=1, stat = "Identity") + 
  geom_text(aes(label = TARP),position = position_stack(vjust = 0.5),
    size=3.3)+
  
  xlab("BSU total points/assists/rebounds") +
  ylab("P/A/R by each player") 

```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# both stacked bar graphs
barp 
bp
```

Occurrences of each Point/Assist/Rebound total. 

```{r echo=FALSE, message=FALSE, warning=FALSE}

fig3 <- plot_ly(dfplayers, x = ~ W_L, y = ~EFG, color = ~Player_Name ,  type = "box" )
fig3 <-  fig3 %>% layout(boxmode = "group", xaxis= list(title = "Win or Loss"), yaxis = list(title = "EFG %"))
fig3

ggplot(dfplayers) + geom_histogram(aes(x = FG_A, fill =Player_Name), binwidth = 1)

fig1 <- plot_ly(dfplayers, x = ~ W_L, y = ~FG_A, color = ~Player_Name ,  type = "box" )
fig1 <-  fig1 %>% layout(boxmode = "group", xaxis= list(title = "Win or Loss"), yaxis = list(title = "FG Attempts"))
fig1

ggplot(dfplayers) + geom_histogram(aes(x = `3P_A`, fill =Player_Name), binwidth = 1)



fig11 <- plot_ly(dfplayers, x = ~ W_L, y = ~dfplayers$`3P_A`, color = ~Player_Name ,  type = "box" )
fig11 <-  fig11 %>% layout(boxmode = "group", xaxis= list(title = "Win or Loss"), yaxis = list(title = "Three Point Attempts"))
fig11

ggplot(dfplayers) + geom_histogram(aes(x = FT_A, fill =Player_Name), binwidth = 1)+ xlim(1,NA)


fig5 <- plot_ly(dfplayers, x = ~ W_L, y = ~FT_A, color = ~Player_Name ,  type = "box" )
fig5 <-  fig5 %>% layout(boxmode = "group", xaxis= list(title = "Win or Loss"), yaxis = list(title = "FT Attempts"))
fig5

```

# Win Probability Based on Player/Team Statistics 

The following is the conditional probability equation/formula. $P(A|B) = \frac{P(A\bigcap B)}{P(B)}$

### Example 

Here $P(A|B)$ is the probability that event A occurs, Ball State wins, given that event B occurs, say Ball State out rebounds the opponent.

$P(A\cap B)$ is the probability that both event A and B occur.

$P(B)$ is the probability that event B occurs, BSU out rebounds the opposing team.

## Complete season 



```{r include=FALSE}
#Rebounds
BOPPR <- na.omit(ifelse(dfteam$TeamCase == "OPP", dfteam$Rebounds_Total, NA))
BR    <- na.omit(ifelse(dfteam$TeamCase == "BSU", dfteam$Rebounds_Total, NA))
#FG_A
BOPPFT <- na.omit(ifelse(dfteam$TeamCase == "OPP", dfteam$FT_A, NA))
BFT    <- na.omit(ifelse(dfteam$TeamCase == "BSU", dfteam$FT_A, NA))
#FG_A
BOPPFA <- na.omit(ifelse(dfteam$TeamCase == "OPP", dfteam$FG_A, NA))
BFA    <- na.omit(ifelse(dfteam$TeamCase == "BSU", dfteam$FG_A, NA))

#EFG
BOPPEFG <- na.omit(ifelse(dfteam$TeamCase == "OPP", dfteam$EFG, NA))
BEFG    <- na.omit(ifelse(dfteam$TeamCase == "BSU", dfteam$EFG, NA))

Result <- na.omit(ifelse(dfteam$TeamCase == "BSU", dfteam$W_L, NA))
Game_Number <- 1:33
Team <- rep("BSU")
g_stats <- data.frame(Game_Number,Result,Team, BFA,BOPPFA, BFT, BOPPFT, BR, BOPPR, BEFG,BOPPEFG)

#F_A binary variable

g_stats$FG_ABV <- case_when(
   BFA > BOPPFA & Result == "W" ~ 1 , TRUE ~ 0
 )
g_stats$TOTFGA <- case_when(
   BFA > BOPPFA  ~ 1 , TRUE ~ 0
 )
#FT binary variable

g_stats$FT_ABV <- case_when(
   BFT > BOPPFT & Result == "W" ~ 1 , TRUE ~ 0
 )

g_stats$TOTFT <- case_when(
   BFT > BOPPFT ~ 1 , TRUE ~ 0
 )
#Rebounds binary variable

g_stats$RBV <- case_when(
   BR > BOPPR & Result == "W" ~ 1 , TRUE ~ 0
 )


g_stats$TOTR <- case_when(
   BR > BOPPR ~ 1 , TRUE ~ 0
 )
#EFG binary variable

g_stats$EFGBV <- case_when(
   BEFG > BOPPEFG & Result == "W" ~ 1 , TRUE ~ 0
 )
g_stats
g_stats$TOTEFG <- case_when(
   BEFG > BOPPEFG ~ 1 , TRUE ~ 0
 )
g_stats

bsufga <- c(sum(g_stats$FG_ABV), mean(g_stats$FG_ABV))
bsufta <- c(sum(g_stats$FT_ABV),mean(g_stats$FT_ABV))
bsuR <- c(sum(g_stats$RBV),mean(g_stats$RBV))
bsuefg <- c(sum(g_stats$EFGBV),mean(g_stats$EFGBV))

t1 <- sum(g_stats$TOTFGA) 
t2 <- sum(g_stats$TOTFT)
t3 <- sum(g_stats$TOTR)
t4 <- sum(g_stats$TOTEFG)
tx <- c(t1,t2,t3,t4)

Szn_Results <- data.frame(bsufga,bsufta, bsuR,bsuefg)
```


```{r include=FALSE}
Szn_Results[nrow(Szn_Results) +1,] <- tx/33

ux <-  Szn_Results[2,]/Szn_Results[3,]

Szn_Results[nrow(Szn_Results) +1,] <- ux

colnames(Szn_Results) <- c("FG_A >","FT_A >"," Rebounds >","EFG% >")
rownames(Szn_Results) <- c("Games Won and had higher___ >","P(A ∩ B)","P(B)","P(A|B)")
Szn_Results <-round(Szn_Results,2)
Punion <- kable(Szn_Results) %>% kable_material(c("striped", "hover"))


```


```{r eval=FALSE, include=FALSE}

## Winning situations

Out of the 20 games Ball State won they took more Field Goal Attempts in 11 games. 

Won 10 games where they out rebounded the opponent.

Won 12 games where they shot more Free Throws. 

Won 17 games where they had a higher EFG%. 


#Games BSU won 
gnx <- na.omit(ifelse(dfteam$TeamCase == "BSU" & dfteam$W_L == "W", dfteam$Game_Number, NA))

#Games BSU won and they got higher FG_A
ax <- na.omit(ifelse(dfteam$TeamCase == "BSU" & dfteam$W_L == "W", dfteam$FG_A, NA))
bx <- na.omit(ifelse(dfteam$TeamCase == "OPP" & dfteam$W_L == "L", dfteam$FG_A, NA))

#Games BSU won and they got higher rebounds
cx <- na.omit(ifelse(dfteam$TeamCase == "BSU" & dfteam$W_L == "W", dfteam$Rebounds_Total, NA))
dx <- na.omit(ifelse(dfteam$TeamCase == "OPP" & dfteam$W_L == "L", dfteam$Rebounds_Total, NA))

#Games BSU won and they got higher Three point attempts
ex <- na.omit(ifelse(dfteam$TeamCase == "BSU" & dfteam$W_L == "W", dfteam$`3P_A`, NA))
fx <- na.omit(ifelse(dfteam$TeamCase == "OPP" & dfteam$W_L == "L", dfteam$`3P_A`, NA))

#Games BSU won and they got higher EFG%
gx <- na.omit(ifelse(dfteam$TeamCase == "BSU" & dfteam$W_L == "W", dfteam$EFG, NA))
hx <- na.omit(ifelse(dfteam$TeamCase == "OPP" & dfteam$W_L == "L", dfteam$EFG, NA))
#data frame that keeps all the new BSU-W data. 
zx <- na.omit(data.frame(gnx,ax,bx, cx, dx,ex,fx,gx,hx))

#New binary variables 
zx$FG_A <-ifelse(zx$ax > zx$bx, 1, 0)
zx$Reb  <-ifelse(zx$cx > zx$dx, 1, 0)
zx$TP   <-ifelse(zx$ex > zx$fx, 1, 0)
zx$EFG  <-ifelse(zx$gx > zx$hx, 1, 0)

meanfga = c(sum(zx$FG_A),mean(zx$FG_A))
meanreb = c(sum(zx$Reb), mean(zx$Reb))
meantp = c(sum(zx$TP), mean(zx$TP))
meanefg = c(sum(zx$EFG),mean(zx$EFG))

wszn_res <- data.frame(meanfga, meanreb,meantp,meanefg)
wszn_res
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
Punion
```

Field Goal Attempts
---------
Out of the 33 games played, Ball State had 11 games where they took more Field Goal attempts and won.

BSU has a 57% chance of winning given they shoot more field goals.

Free Throws Attempts
---------
They had 10 games where they attempted more free throws and won. 

The probability that BSU wins given they shoot more Free Throws is 83%.

Rebounds
---------

They had 10 games where they out rebounded and won. 

The probability that BSU wins given they out rebound their opponent is 90%.

Effective Field Goal Percentage
---------
They had 17 games where they had the higher EFG% and won. 

The probability that BSU wins given they have a higher Effective Field Goal Percentage is 89%.




# Apply General Linearized Models

```{r}
dfbsu <- subset(dfteam, Team == 'BSU')
dfbsu <- dfbsu %>% mutate(BWL = case_when(W_L == "W" ~ 1,
                       W_L == "L" ~ 0))
```


```{r}
mylogit <- glm(BWL ~ EFG   + Rebounds_Total + FT_A + Assist , data = dfbsu, family = binomial())
summary(mylogit)
```


# Identify Team and Player Statistical Trends. 









